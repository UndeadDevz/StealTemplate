--[[
	‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	EFECTO VISUAL DE SUBIDA DE NIVEL - CLIENTE
	‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	
	Este LocalScript escucha cuando CUALQUIER jugador sube de nivel
	y muestra el efecto de part√≠culas.
	
	INSTRUCCIONES DE CONFIGURACI√ìN:
	1. En ReplicatedStorage, crea una carpeta llamada "Effects"
	2. Crea una Part invisible llamada "LevelUpEffect" con estas propiedades:
	   - Transparency = 1
	   - CanCollide = false
	   - Anchored = false
	   - Size = Vector3.new(1, 1, 1)
	
	3. Dentro de "LevelUpEffect", crea un Attachment
	4. Dentro del Attachment, agrega tus ParticleEmitters con:
	   - Enabled = false (importante, para que no emitan desde el inicio)
	   - Rate = El rate que quieras (ejemplo: 20, 50, 100)
	   - Lifetime = Cu√°nto duran las part√≠culas (ejemplo: 1-2 segundos)
	
	5. SONIDO: En ReplicatedStorage > Effects, crea un Sound llamado "LevelUpSound"
	   - SoundId = ID de tu sonido favorito (ejemplo: rbxassetid://6026984224)
	   - Volume = 0.5 (ajusta seg√∫n prefieras)
	   - RollOffMaxDistance = 100 (para que se escuche de lejos)
	   - RollOffMinDistance = 10
	
	‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- CONFIGURACI√ìN
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local DURACION_EFECTO = 2 -- Segundos que las part√≠culas est√°n activas

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Esperar al RemoteEvent
local remoteEventsFolder = ReplicatedStorage:WaitForChild("RemoteEvents")
local efectoLvlUp = remoteEventsFolder:WaitForChild("EfectoLvlUp")

-- Buscar el efecto de part√≠culas y sonido
local effectsFolder = ReplicatedStorage:FindFirstChild("Effects")
local efectoOriginal = effectsFolder and effectsFolder:FindFirstChild("LevelUpEffect")
local sonidoOriginal = effectsFolder and effectsFolder:FindFirstChild("LevelUpSound")

-- Debug: Verificar si existe el sonido
if sonidoOriginal then
	print("‚úÖ Sonido encontrado:", sonidoOriginal.SoundId, "Volume:", sonidoOriginal.Volume)
else
	warn("‚ö†Ô∏è No se encontr√≥ 'LevelUpSound' en ReplicatedStorage > Effects")
end

-- Funci√≥n para activar part√≠culas temporalmente
local function activarParticulas(particula)
	if not particula:IsA("ParticleEmitter") then
		return
	end

	particula.Enabled = true

	-- Desactivar despu√©s de la duraci√≥n configurada
	task.delay(DURACION_EFECTO, function()
		particula.Enabled = false
	end)
end

-- Evento cuando alguien sube de nivel
efectoLvlUp.OnClientEvent:Connect(function(personaje, nuevoNivel)
	print("üîî Evento recibido: " .. (personaje and personaje.Name or "???") .. " nivel " .. tostring(nuevoNivel))
	
	-- Validar que el personaje existe
	if not personaje or not personaje:IsA("Model") then
		warn("‚ö†Ô∏è Personaje inv√°lido")
		return
	end

	local root = personaje:FindFirstChild("HumanoidRootPart")
	if not root then
		warn("‚ö†Ô∏è No se encontr√≥ HumanoidRootPart en " .. personaje.Name)
		return
	end
	
	-- REPRODUCIR SONIDO
	if sonidoOriginal and sonidoOriginal:IsA("Sound") then
		local sonidoClon = sonidoOriginal:Clone()
		sonidoClon.Parent = root
		
		print("üîä Reproduciendo sonido:", sonidoClon.SoundId, "en", root:GetFullName())
		
		-- Asegurar que el sonido se escuche
		sonidoClon.Volume = math.max(sonidoClon.Volume, 0.5) -- M√≠nimo 0.5
		sonidoClon:Play()
		
		-- Verificar si el sonido est√° reproduci√©ndose
		task.wait(0.1)
		if sonidoClon.IsPlaying then
			print("‚úÖ Sonido reproduci√©ndose correctamente")
		else
			warn("‚ùå El sonido NO se est√° reproduciendo. Verifica el SoundId:", sonidoClon.SoundId)
		end
		
		Debris:AddItem(sonidoClon, math.max(sonidoClon.TimeLength, 3) + 0.5)
	else
		warn("‚ö†Ô∏è No se pudo reproducir el sonido")
	end

	-- REPRODUCIR SONIDO
	if sonidoOriginal and sonidoOriginal:IsA("Sound") then
		local sonidoClon = sonidoOriginal:Clone()
		sonidoClon.Parent = root
		sonidoClon:Play()
		Debris:AddItem(sonidoClon, sonidoClon.TimeLength + 0.1)
	end

	-- Si no hay efecto configurado, solo mostrar mensaje en consola
	if not efectoOriginal then
		print("‚≠ê " .. personaje.Name .. " subi√≥ al nivel " .. nuevoNivel .. "!")
		return
	end

	-- Clonar el efecto localmente
	local clon = efectoOriginal:Clone()
	clon.Parent = root

	-- Ajustar posici√≥n y anclar al personaje
	if clon:IsA("BasePart") then
		clon.CFrame = root.CFrame
		local weld = Instance.new("WeldConstraint")
		weld.Part0 = clon
		weld.Part1 = root
		weld.Parent = clon
	end

	-- ACTIVAR LAS PART√çCULAS
	-- 1. Las part√≠culas dentro del Attachment
	local attach = clon:FindFirstChildWhichIsA("Attachment")
	if attach then
		for _, hijo in pairs(attach:GetChildren()) do
			activarParticulas(hijo)
		end
	end

	-- 2. Las part√≠culas que est√°n directamente en el objeto
	for _, hijo in pairs(clon:GetChildren()) do
		activarParticulas(hijo)
	end

	-- Mostrar mensaje en consola
	print("‚≠ê " .. personaje.Name .. " subi√≥ al nivel " .. nuevoNivel .. "!")

	-- Limpiar el efecto despu√©s del lifetime m√°ximo de las part√≠culas + duraci√≥n
	Debris:AddItem(clon, DURACION_EFECTO + 3)
end)

print("üéÆ Sistema de efectos de nivel iniciado")
