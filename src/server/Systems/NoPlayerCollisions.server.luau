--[[
	NO PLAYER COLLISIONS - Desactiva colisiones entre jugadores
	Usa CollisionGroup para que los jugadores no colisionen entre s√≠
]]

local PhysicsService = game:GetService("PhysicsService")
local Players = game:GetService("Players")

local COLLISION_GROUP = "Players"

-- ========== SETUP COLLISION GROUP PRIMERO ==========
-- Registrar grupo (ignora error si ya existe)
pcall(function()
	PhysicsService:RegisterCollisionGroup(COLLISION_GROUP)
end)

-- Hacer que Players no colisione consigo mismo
PhysicsService:CollisionGroupSetCollidable(COLLISION_GROUP, COLLISION_GROUP, false)
print("[NoPlayerCollisions] ‚úì CollisionGroup configurado")

-- ========== APLICAR A PERSONAJES ==========
local function applyCollisionGroup(character)
	if not character or not character.Parent then return end

	-- Aplicar a todas las partes existentes
	for _, part in ipairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CollisionGroup = COLLISION_GROUP
		end
	end
end

local function setupCharacter(player, character)
	-- Esperar a que el personaje est√© listo
	local hrp = character:WaitForChild("HumanoidRootPart", 10)
	if not hrp then
		warn("[NoPlayerCollisions] ‚ö†Ô∏è HRP no encontrado para:", player.Name)
		return
	end

	-- Aplicar inmediatamente
	applyCollisionGroup(character)

	-- Aplicar de nuevo despu√©s de un delay (para partes tard√≠as)
	task.delay(0.5, function()
		if character and character.Parent then
			applyCollisionGroup(character)
		end
	end)

	-- Aplicar una vez m√°s despu√©s de 1 segundo (por si acaso)
	task.delay(1, function()
		if character and character.Parent then
			applyCollisionGroup(character)
		end
	end)

	-- Escuchar nuevas partes (accesorios que se agregan despu√©s)
	character.DescendantAdded:Connect(function(desc)
		if desc:IsA("BasePart") then
			desc.CollisionGroup = COLLISION_GROUP
		end
	end)

	print("[NoPlayerCollisions] ‚úì Aplicado a:", player.Name)
end

local function onPlayerAdded(player)
	-- Futuros respawns - conectar PRIMERO
	player.CharacterAdded:Connect(function(char)
		task.spawn(setupCharacter, player, char)
	end)

	-- Personaje actual (si existe)
	if player.Character then
		task.spawn(setupCharacter, player, player.Character)
	end
end

-- ========== INICIALIZAR ==========
-- Conectar evento PlayerAdded PRIMERO (antes de iterar)
Players.PlayerAdded:Connect(onPlayerAdded)

-- Jugadores que ya existen
for _, player in ipairs(Players:GetPlayers()) do
	task.spawn(onPlayerAdded, player)
end

-- IMPORTANTE: Re-aplicar a TODOS los personajes despu√©s de 2 segundos
-- Esto asegura que jugadores que se unieron muy r√°pido tambi√©n tengan el CollisionGroup
task.delay(2, function()
	print("[NoPlayerCollisions] üîÑ Re-aplicando a todos los jugadores...")
	for _, player in ipairs(Players:GetPlayers()) do
		if player.Character then
			applyCollisionGroup(player.Character)
			print("[NoPlayerCollisions] ‚úì Re-aplicado a:", player.Name)
		end
	end
end)

print("[NoPlayerCollisions] ‚úì Sistema listo")
