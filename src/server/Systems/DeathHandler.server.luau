--[[
	DEATH HANDLER - Sistema simple de muerte y checkpoint
	Muestra el bot√≥n cuando el jugador muere si tiene checkpoint guardado
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Configurar respawn r√°pido (3 segundos)
Players.RespawnTime = 3

-- Esperar CheckpointTracking
print("[DeathHandler] Esperando CheckpointTracking...")
local CheckpointTracking = nil
for i = 1, 20 do
	CheckpointTracking = _G.CheckpointTracking
	if CheckpointTracking then break end
	task.wait(0.5)
end

if not CheckpointTracking then
	warn("[DeathHandler] ‚ùå No se encontr√≥ CheckpointTracking")
	return
end

print("[DeathHandler] ‚úÖ CheckpointTracking encontrado")

-- Esperar RemoteEvents
local remoteEvents = ReplicatedStorage:WaitForChild("RemoteEvents", 10)
if not remoteEvents then
	warn("[DeathHandler] ‚ùå No se encontr√≥ RemoteEvents")
	return
end

local showEvent = remoteEvents:WaitForChild("ShowDeathPopup", 10)
local teleportEvent = remoteEvents:WaitForChild("TeleportToCheckpoint", 10)

if not showEvent or not teleportEvent then
	warn("[DeathHandler] ‚ùå No se encontraron los RemoteEvents")
	return
end

print("[DeathHandler] ‚úÖ RemoteEvents encontrados")

-- Funci√≥n para conectar a un jugador
local function setupPlayer(player)
	print("[DeathHandler] üîß Configurando jugador:", player.Name)

	-- Funci√≥n para conectar a un personaje
	local function setupCharacter(character)
		print("[DeathHandler] üë§ Configurando personaje para:", player.Name)
		local humanoid = character:WaitForChild("Humanoid")

		print("[DeathHandler] ‚ù§Ô∏è Conectando evento Died para:", player.Name)
		humanoid.Died:Connect(function()
			print("üíÄ", player.Name, "muri√≥")

			-- Verificar si tiene checkpoint
			local checkpoint = CheckpointTracking[player]
			if not checkpoint then
				print("‚ÑπÔ∏è", player.Name, "no tiene checkpoint guardado")
				return
			end

			print("‚úÖ", player.Name, "tiene checkpoint:", checkpoint.CheckpointName)

			-- Esperar a que respawnee (3 segundos)
			task.wait(3.1)

			-- Verificar que sigue conectado
			if not player or not player.Parent then
				print("‚ö†Ô∏è", player.Name, "se desconect√≥")
				return
			end

			-- Mostrar bot√≥n
			print("üì¢ ENVIANDO EVENTO para mostrar bot√≥n a", player.Name)
			showEvent:FireClient(player, checkpoint)
		end)
	end

	-- Conectar a CharacterAdded
	player.CharacterAdded:Connect(setupCharacter)

	-- Si ya tiene personaje, configurarlo
	if player.Character then
		setupCharacter(player.Character)
	end
end

-- Conectar jugadores nuevos
Players.PlayerAdded:Connect(setupPlayer)

-- Conectar jugadores que ya est√©n en el juego
for _, player in pairs(Players:GetPlayers()) do
	setupPlayer(player)
end

-- Handler de teleport
teleportEvent.OnServerEvent:Connect(function(player)
	print("üåÄ Teleport solicitado por", player.Name)

	local checkpoint = CheckpointTracking[player]
	if not checkpoint then
		warn("‚ö†Ô∏è No hay checkpoint para", player.Name)
		return
	end

	local character = player.Character
	if not character then
		warn("‚ö†Ô∏è", player.Name, "no tiene personaje")
		return
	end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then
		warn("‚ö†Ô∏è", player.Name, "no tiene HumanoidRootPart")
		return
	end

	print("üíé Teleportando", player.Name, "a", checkpoint.CheckpointName)
	rootPart.CFrame = CFrame.new(checkpoint.Position + Vector3.new(0, 5, 0))
end)

print("[DeathHandler] ‚úÖ Sistema activado")
