--[[
	â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	DEATH HANDLER SYSTEM
	â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

	Maneja la muerte del jugador y el sistema de teleport a checkpoints.

	FLUJO:
	1. Jugador muere â†’ Humanoid.Died
	2. Verifica si tiene checkpoint guardado
	3. Si SÃ tiene checkpoint: espera 3s y muestra popup
	4. Si NO tiene checkpoint: solo respawn normal
	5. Si compra teleport: valida y teleporta al checkpoint

	â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CollectionService = game:GetService("CollectionService")

-- Configurar respawn rÃ¡pido (3 segundos)
Players.RespawnTime = 3

-- Esperar a que CheckpointTracking estÃ© disponible
print("[DeathHandler] â³ Esperando a que CheckpointSystem estÃ© listo...")
local CheckpointTracking = nil
local maxWaitTime = 10
local waitedTime = 0

while not CheckpointTracking and waitedTime < maxWaitTime do
	CheckpointTracking = _G.CheckpointTracking
	if not CheckpointTracking then
		task.wait(0.5)
		waitedTime = waitedTime + 0.5
	end
end

if not CheckpointTracking then
	warn("[DeathHandler] âŒ CheckpointTracking no encontrado despuÃ©s de", maxWaitTime, "segundos")
	warn("[DeathHandler] âŒ AsegÃºrate de que CheckpointSystem.server.luau existe en src/server/Systems/")
	return
end

print("[DeathHandler] âœ… CheckpointTracking encontrado")

-- Esperar RemoteEvents
local function esperarRemoteEvents()
	local remoteEventsFolder = ReplicatedStorage:WaitForChild("RemoteEvents", 10)
	if not remoteEventsFolder then
		warn("[DeathHandler] âš ï¸ RemoteEvents folder no encontrado")
		return nil
	end

	local showDeathPopupEvent = remoteEventsFolder:WaitForChild("ShowDeathPopup", 10)
	local teleportToCheckpointEvent = remoteEventsFolder:WaitForChild("TeleportToCheckpoint", 10)

	if not showDeathPopupEvent or not teleportToCheckpointEvent then
		warn("[DeathHandler] âš ï¸ RemoteEvents no encontrados")
		return nil
	end

	return showDeathPopupEvent, teleportToCheckpointEvent
end

local showDeathPopupEvent, teleportToCheckpointEvent = esperarRemoteEvents()
if not showDeathPopupEvent or not teleportToCheckpointEvent then
	return
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- MANEJAR MUERTE DEL JUGADOR
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function OnCharacterAdded(player, character)
	local humanoid = character:WaitForChild("Humanoid")

	humanoid.Died:Connect(function()
		print("ğŸ’€ Jugador muriÃ³:", player.Name)

		-- Verificar si tiene checkpoint guardado
		local checkpointData = CheckpointTracking[player]

		if not checkpointData then
			print("â„¹ï¸  No hay checkpoint guardado para:", player.Name, "- Solo respawn normal")
			return
		end

		-- Tiene checkpoint - mostrar popup despuÃ©s del respawn
		task.spawn(function()
			-- Esperar 3 segundos (tiempo de respawn automÃ¡tico)
			task.wait(3)

			-- Verificar que el jugador aÃºn estÃ¡ conectado
			if not player or not player.Parent then
				return
			end

			print("ğŸ“¢ Mostrando popup de checkpoint para:", player.Name)

			-- Enviar info del checkpoint al cliente
			showDeathPopupEvent:FireClient(player, checkpointData)
		end)
	end)
end

-- Conectar a jugadores
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		OnCharacterAdded(player, character)
	end)

	-- Si ya tiene personaje
	if player.Character then
		OnCharacterAdded(player, player.Character)
	end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- HANDLER: TELEPORT A CHECKPOINT (despuÃ©s de compra)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
teleportToCheckpointEvent.OnServerEvent:Connect(function(player)
	print("ğŸŒ€ Teleport request de:", player.Name)

	local checkpointData = CheckpointTracking[player]

	if not checkpointData then
		warn("âš ï¸  No hay checkpoint para", player.Name)
		return
	end

	-- Validar que el checkpoint aÃºn existe
	local checkpointExists = false
	for _, parte in CollectionService:GetTagged("Checkpoint") do
		if parte:GetAttribute("CheckpointName") == checkpointData.CheckpointName then
			checkpointExists = true
			break
		end
	end

	if not checkpointExists then
		warn("âš ï¸  Checkpoint eliminado:", checkpointData.CheckpointName)
		-- TODO: Opcional - enviar mensaje de error al cliente
		return
	end

	-- Verificar que el jugador estÃ¡ vivo
	local character = player.Character
	if not character then
		warn("âš ï¸  Jugador no tiene personaje:", player.Name)
		return
	end

	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid or humanoid.Health <= 0 then
		warn("âš ï¸  Jugador estÃ¡ muerto, no se puede teleportar:", player.Name)
		return
	end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then
		warn("âš ï¸  No se encontrÃ³ HumanoidRootPart para:", player.Name)
		return
	end

	print("ğŸ’ Teleportando a checkpoint:", player.Name, "->", checkpointData.CheckpointName)

	-- Teleportar con offset +5 en Y (evitar quedar atascado)
	rootPart.CFrame = CFrame.new(checkpointData.Position + Vector3.new(0, 5, 0))
end)

print("[DeathHandler] âœ… Sistema activado (RespawnTime = 3s)")
